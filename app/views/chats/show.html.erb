<%# Container - Desktop com padding, Mobile sem padding (ocupa tudo) %>
<div class="min-h-[calc(100vh-80px)] bg-gray-950 md:py-4 md:px-4">
  
  <%# Chat Container - Mobile: tela cheia | Desktop: max-width centralizado %>
  <div class="flex flex-col w-full md:max-w-5xl md:mx-auto bg-black md:border border-green-500/20 md:rounded-xl overflow-hidden shadow-[0_0_30px_rgba(34,197,94,0.1)] font-mono" 
       style="height: calc(100vh - 80px);">
    
    <%# Header - Altura fixa %>
    <div class="p-3 md:p-4 border-b border-green-500/10 bg-green-500/5 backdrop-blur-md flex items-center justify-between flex-shrink-0 h-[60px] md:h-[70px]">
      <div class="flex items-center gap-2 md:gap-3">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg border border-green-500/30 flex items-center justify-center bg-green-500/5 text-green-500 font-bold text-xs md:text-sm">
          <%= @other_user.nickname&.at(0)&.upcase || "?" %>
        </div>
        <div>
          <p class="text-green-500 font-bold text-[10px] md:text-xs tracking-[0.2em] uppercase">@<%= @other_user.nickname %></p>
          <div class="flex items-center gap-1 md:gap-2">
            <span class="relative flex h-1.5 w-1.5 md:h-2 md:w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-1.5 w-1.5 md:h-2 md:w-2 bg-green-500"></span>
            </span>
            <span class="text-[7px] md:text-[8px] text-green-700 uppercase tracking-[0.3em]">Signal: Secure</span>
          </div>
        </div>
      </div>
      <%= link_to "EXIT", friends_path, class: "text-[8px] md:text-[9px] font-bold text-red-900 border border-red-900/30 px-2 md:px-3 py-1 md:py-1.5 rounded hover:bg-red-900/10 transition-all uppercase tracking-widest" %>
    </div>

    <%# Messages Area - SCROLL AQUI %>
    <div class="p-3 md:p-6 space-y-3 md:space-y-4 bg-[#020617]" 
         id="messages"
         style="flex: 1 1 0%; min-height: 0; overflow-y: scroll !important; -webkit-overflow-scrolling: touch; max-height: 100%;">
      <%= render @messages %>
    </div>

    <%# Input Area - Altura automática, responsivo %>
    <div class="p-3 md:p-4 border-t border-green-500/10 bg-green-500/5 backdrop-blur-md flex-shrink-0">
      <%# Preview de Reply %>
      <div id="reply-preview" class="hidden p-2 bg-green-500/10 border border-green-500/20 mb-2 md:mb-3 rounded text-[8px] md:text-[9px] text-green-500 flex justify-between uppercase tracking-widest items-center">
        <div class="flex items-center gap-2">
          <i class="ph-bold ph-arrow-bend-up-left text-[10px] md:text-xs"></i>
          <span id="reply-text" class="line-clamp-1"></span>
        </div>
        <button onclick="cancelReply()" type="button" class="text-red-700 hover:text-red-500 transition-colors">
          <i class="ph-bold ph-x text-[10px] md:text-xs"></i>
        </button>
      </div>

      <%# Form de Mensagem - Responsivo %>
      <%= form_with(model: [@chat, Message.new], class: "flex gap-2 md:gap-3", id: "message-form") do |f| %>
        <%= f.hidden_field :parent_id, id: "reply_id" %>
        <%= f.text_field :body, 
                         id: "message_body", 
                         placeholder: "> ENTER_COMMAND...", 
                         autocomplete: "off",
                         class: "flex-1 bg-green-500/5 border border-green-500/20 rounded-lg px-3 md:px-4 py-2 md:py-3 text-green-500 placeholder:text-green-900 focus:ring-1 focus:ring-green-500 focus:border-green-500 text-[11px] md:text-xs font-mono transition-all",
                         onkeypress: "if(event.key === 'Enter' && !event.shiftKey) { this.form.requestSubmit(); return false; }" %>
        <%= f.submit "SEND", 
                     class: "bg-green-500/10 border border-green-500/30 px-4 md:px-6 py-2 md:py-3 rounded-lg text-[9px] md:text-[10px] font-bold text-green-500 hover:bg-green-500/20 hover:border-green-500 transition-all shadow-[0_0_15px_rgba(34,197,94,0.1)] uppercase tracking-widest cursor-pointer" %>
      <% end %>
    </div>
  </div>
</div>

<%# CSS adicional para mobile %>
<style>
  /* Remove padding do body no mobile para chat */
  @media (max-width: 768px) {
    body:has(#messages) {
      padding: 0 !important;
      margin: 0 !important;
    }
    
    /* Garante que o chat ocupe 100% no mobile */
    body:has(#messages) > main {
      padding: 0 !important;
      margin: 0 !important;
      max-width: 100% !important;
    }
  }
</style>

<%# Container para context menus %>
<div id="context-menus-container">
  <%= yield :context_menus %>
</div>

<%= javascript_tag do %>
  function replyToMessage(messageId, messageBody) {
    const replyPreview = document.getElementById('reply-preview');
    const replyText = document.getElementById('reply-text');
    const replyIdInput = document.getElementById('reply_id');
    const messageInput = document.getElementById('message_body');
    
    replyIdInput.value = messageId;
    replyText.textContent = `Replying to: "${messageBody.substring(0, 50)}${messageBody.length > 50 ? '...' : ''}"`; 
    replyPreview.classList.remove('hidden');
    messageInput.focus();
  }
  
  function cancelReply() {
    document.getElementById('reply-preview').classList.add('hidden');
    document.getElementById('reply_id').value = '';
  }
  
  function scrollToBottom(smooth = false) {
    const messagesDiv = document.getElementById('messages');
    if (messagesDiv) {
      if (smooth) {
        messagesDiv.scrollTo({
          top: messagesDiv.scrollHeight,
          behavior: 'smooth'
        });
      } else {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }
  }
  
  // Scroll inicial ao carregar a página
  document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
  });
  
  // Scroll quando nova mensagem chega via Turbo Stream
  document.addEventListener('turbo:frame-load', function() {
    scrollToBottom();
  });
  
  // Scroll após renderização do Turbo
  document.addEventListener('turbo:render', function() {
    scrollToBottom();
  });
  
  // Observa mudanças no container de mensagens
  const messagesDiv = document.getElementById('messages');
  if (messagesDiv) {
    const observer = new MutationObserver(function() {
      scrollToBottom(true);
    });
    
    observer.observe(messagesDiv, {
      childList: true,
      subtree: true
    });
  }
  
  // Limpar form após enviar e rolar para o fundo
  const messageForm = document.getElementById('message-form');
  if (messageForm) {
    messageForm.addEventListener('turbo:submit-end', function(event) {
      if (event.detail.success) {
        document.getElementById('message_body').value = '';
        cancelReply();
        setTimeout(() => scrollToBottom(true), 50);
        setTimeout(() => scrollToBottom(true), 200);
        setTimeout(() => scrollToBottom(true), 500);
      }
    });
  }
<% end %>


