<%# Container que ocupa toda a altura da viewport menos o navbar %>
<div class="h-[calc(100vh-80px)] bg-gray-950 flex items-center justify-center p-4">
  
  <%# Chat Container - Altura fixa, não precisa rolar a página %>
  <div class="flex flex-col h-full w-full max-w-5xl bg-black border border-green-500/20 rounded-xl overflow-hidden shadow-[0_0_30px_rgba(34,197,94,0.1)] font-mono">
    
    <%# Header - Fixo no topo do chat %>
    <div class="p-4 border-b border-green-500/10 bg-green-500/5 backdrop-blur-md flex items-center justify-between shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg border border-green-500/30 flex items-center justify-center bg-green-500/5 text-green-500 font-bold text-sm">
          <%= @other_user.nickname&.at(0)&.upcase || "?" %>
        </div>
        <div>
          <p class="text-green-500 font-bold text-xs tracking-[0.2em] uppercase">@<%= @other_user.nickname %></p>
          <div class="flex items-center gap-2">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span class="text-[8px] text-green-700 uppercase tracking-[0.3em]">Signal: Secure</span>
          </div>
        </div>
      </div>
      <%= link_to "[TERMINATE_SESSION]", friends_path, class: "text-[9px] font-bold text-red-900 border border-red-900/30 px-3 py-1.5 rounded hover:bg-red-900/10 transition-all uppercase tracking-widest" %>
    </div>

    <%# Messages Area - AQUI É O ÚNICO LUGAR QUE ROLA %>
    <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-[#020617] custom-scrollbar" id="messages">
      <%= render @messages %>
    </div>

    <%# Input Area - SEMPRE VISÍVEL NO FUNDO %>
    <div class="p-4 border-t border-green-500/10 bg-green-500/5 backdrop-blur-md shrink-0">
      <%# Preview de Reply %>
      <div id="reply-preview" class="hidden p-2 bg-green-500/10 border border-green-500/20 mb-3 rounded text-[9px] text-green-500 flex justify-between uppercase tracking-widest items-center">
        <div class="flex items-center gap-2">
          <i class="ph-bold ph-arrow-bend-up-left text-xs"></i>
          <span id="reply-text" class="line-clamp-1"></span>
        </div>
        <button onclick="cancelReply()" type="button" class="text-red-700 hover:text-red-500 transition-colors">
          <i class="ph-bold ph-x text-xs"></i>
        </button>
      </div>

      <%# Form de Mensagem %>
      <%= form_with(model: [@chat, Message.new], class: "flex gap-3", id: "message-form") do |f| %>
        <%= f.hidden_field :parent_id, id: "reply_id" %>
        <%= f.text_field :body, 
                         id: "message_body", 
                         placeholder: "> ENTER_COMMAND...", 
                         autocomplete: "off",
                         class: "flex-1 bg-green-500/5 border border-green-500/20 rounded-lg px-4 py-3 text-green-500 placeholder:text-green-900 focus:ring-1 focus:ring-green-500 focus:border-green-500 text-xs font-mono transition-all" %>
        <%= f.submit "[BROADCAST_SIGNAL]", 
                     class: "bg-green-500/10 border border-green-500/30 px-6 py-3 rounded-lg text-[10px] font-bold text-green-500 hover:bg-green-500/20 hover:border-green-500 transition-all shadow-[0_0_15px_rgba(34,197,94,0.1)] uppercase tracking-widest cursor-pointer" %>
      <% end %>
    </div>
  </div>
</div>

<%# JavaScript para Reply e Auto-scroll %>
<script>
  function replyToMessage(messageId, messageBody) {
    const replyPreview = document.getElementById('reply-preview');
    const replyText = document.getElementById('reply-text');
    const replyIdInput = document.getElementById('reply_id');
    const messageInput = document.getElementById('message_body');
    
    replyIdInput.value = messageId;
    replyText.textContent = `Replying to: "${messageBody.substring(0, 50)}${messageBody.length > 50 ? '...' : ''}"`;
    replyPreview.classList.remove('hidden');
    messageInput.focus();
  }
  
  function cancelReply() {
    document.getElementById('reply-preview').classList.add('hidden');
    document.getElementById('reply_id').value = '';
  }
  
  function scrollToBottom() {
    const messagesDiv = document.getElementById('messages');
    if (messagesDiv) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }
  
  document.addEventListener('DOMContentLoaded', scrollToBottom);
  document.addEventListener('turbo:frame-load', scrollToBottom);
  
  document.getElementById('message-form')?.addEventListener('turbo:submit-end', function(event) {
    if (event.detail.success) {
      document.getElementById('message_body').value = '';
      cancelReply();
      setTimeout(scrollToBottom, 100);
    }
  });
</script>

<style>
  /* Scrollbar customizada */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(34, 197, 94, 0.05);
    border-radius: 4px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 4px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.5);
  }
  
  /* Previne scroll na página inteira */
  body:has(#messages) {
    overflow: hidden;
  }
</style>


