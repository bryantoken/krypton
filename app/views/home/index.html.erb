<%# INDEX.HTML.ERB - NEO-BRUTALIST MINIMAL v6.1 COMPLETO %>
<div class="min-h-screen bg-black text-green-500 font-mono selection:bg-green-500 selection:text-black overflow-hidden">

  <%# Subtle Particle Overlay Minimal %>
  <canvas id="particle-overlay" class="fixed inset-0 z-0 opacity-8 pointer-events-none"></canvas>

  <div class="max-w-[1400px] mx-auto relative z-10 flex flex-col lg:flex-row min-h-screen border-x-4 border-green-500 bg-gradient-to-br from-black via-black to-green-950">

    <%# LATERAL ESQUERDA: NODES %>
    <% if user_signed_in? %>
      <aside class="lg:w-72 border-r-4 border-green-500 bg-black/95 backdrop-blur-sm hidden lg:flex flex-col shadow-[8px_0_20px_rgba(34,197,94,0.3)]">
        <div class="p-6 border-b-4 border-green-500 bg-green-500/10 text-black font-black text-[11px] tracking-[0.3em] uppercase neon-glow">
          [01] NODE_IDENT
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-glow">
          <% @nodes.each do |node| %>
            <div class="p-3 border-2 border-transparent hover:border-green-500 hover:bg-green-500/10 cursor-crosshair group transition-all duration-200 hover:animate-glitch hover:shadow-[4px_4px_0_rgba(34,197,94,0.5)]">
              <span class="text-[12px] font-black uppercase block truncate group-hover:text-white glitch-text">
                > <%= node.email.split('@').first %>
              </span>
            </div>
          <% end %>
        </div>
        <div class="p-6 border-t-4 border-green-500 text-[10px] text-green-400 font-black bg-green-500/5 neon-glow">
          STATUS: ENCRYPTED // IP: <%= request.remote_ip %>
        </div>
      </aside>
    <% end %>

    <%# CENTRO: FEED %>
    <main class="flex-1 flex flex-col min-w-0 bg-black/50 backdrop-blur-md">
      <%# Header %>
      <div class="p-12 border-b-4 border-green-500 flex flex-col md:flex-row justify-between items-start md:items-end gap-6 relative overflow-hidden">
        <div class="relative">
          <h1 class="text-7xl md:text-9xl font-black tracking-[-0.05em] uppercase leading-[0.75] mb-4 italic bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-green-200 neon-glow-lg">
            FEED
          </h1>
          <p class="text-[12px] opacity-50 uppercase tracking-[0.4em] animate-pulse">Krypton_Network_Protocol_v6.1</p>
        </div>
        <% if user_signed_in? %>
          <%= link_to "+ TRANSMIT", new_post_path, class: "group bg-green-500 text-black px-10 py-6 font-black text-base border-4 border-black shadow-[8px_8px_0px_#fff] hover:shadow-[4px_4px_0px_rgba(34,197,94,0.5)] hover:translate-x-2 hover:translate-y-2 active:shadow-none active:translate-x-0 active:translate-y-0 transition-all duration-200 uppercase tracking-widest neon-glow hover:animate-pulse" %>
        <% end %>
      </div>

      <%# Conteúdo %>
      <div class="flex-1 p-8 lg:p-16 overflow-y-auto space-y-16 scrollbar-glow pb-48">
        <% if user_signed_in? %>
          <div class="border-4 border-green-500 p-8 bg-green-500/10 shadow-[6px_6px_0px_rgba(34,197,94,0.3)] relative group">
            <div class="flex items-center gap-8">
              <span class="text-3xl font-black animate-pulse opacity-70 relative">></span>
              <input type="text" placeholder="WRITE_LOG_TO_MAINFRAME..." class="w-full bg-transparent border-none outline-none text-2xl font-black placeholder:italic placeholder:text-green-700 uppercase typing-input focus:neon-glow-lg">
              <span class="w-3 h-8 bg-green-500 animate-blink ml-2"></span>
            </div>
          </div>
        <% end %>

        <div class="grid grid-cols-1 xl:grid-cols-[2fr_1fr] 2xl:grid-cols-[1.5fr_1fr_1fr] gap-16 pb-48">
          <% if @posts.any? %>
             <%= render @posts %>
          <% end %>
        </div>
      </div>
    </main>

    <%# LATERAL DIREITA: SIGNALS %>
    <% if user_signed_in? %>
      <aside class="hidden xl:flex w-96 border-l-4 border-green-500 bg-black/95 backdrop-blur-sm flex-col shadow-[-8px_0_20px_rgba(34,197,94,0.3)]">
        <div class="p-6 border-b-4 border-green-500 bg-green-500/10 text-black font-black text-[11px] tracking-[0.3em] uppercase neon-glow">
          [02] LIVE_SIGNALS
        </div>
        <div class="p-8 space-y-10 overflow-y-auto scrollbar-glow flex-1">
          <% @recent_messages.each do |msg| %>
            <div class="border-b-2 border-green-900/50 pb-8 opacity-70 hover:opacity-100 transition-all duration-300 cursor-default group hover:bg-green-500/5 hover:shadow-[4px_4px_10px_rgba(34,197,94,0.2)] p-4 rounded-none">
              <p class="text-[13px] leading-tight mb-4 italic font-medium neon-glow-sm">"<%= msg.body.truncate(120) %>"</p>
              <div class="flex justify-between text-[10px] font-black uppercase text-green-600 tracking-[0.2em]">
                <span>SRC_NODE_<%= msg.id %></span>
                <span><%= msg.created_at.strftime("%H:%M:%S") %></span>
              </div>
            </div>
          <% end %>
        </div>
      </aside>
    <% end %>

  </div>

  <style>
    /* Todas as classes CSS iguais à versão anterior (neon-glow, glitch, scrollbar-glow, typing-input, animate-blink, etc.) */
    * { border-radius: 0 !important; }
    .neon-glow { text-shadow: 0 0 8px rgba(34,197,94,0.6); }
    .neon-glow-lg { text-shadow: 0 0 12px rgba(34,197,94,0.8), 0 0 24px rgba(34,197,94,0.4); }
    .neon-glow-sm { text-shadow: 0 0 5px rgba(34,197,94,0.5); }
    .scrollbar-glow::-webkit-scrollbar { width: 12px; height: 12px; }
    .scrollbar-glow::-webkit-scrollbar-thumb { background: rgba(34,197,94,0.7); border: 3px solid black; box-shadow: 0 0 10px rgba(34,197,94,0.5); }
    .scrollbar-glow::-webkit-scrollbar-track { background: black; }
    @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
    .animate-glitch { animation: glitch 0.3s linear infinite; }
    @keyframes typing { 0%, 100% { width: 0; } 50% { width: 100%; } }
    .typing-input::placeholder { animation: typing 3s steps(20) infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    .animate-blink { animation: blink 1s infinite; }
    canvas { image-rendering: pixelated; will-change: transform; }
  </style>

  <script>
    (function() {
      const c = document.getElementById('particle-overlay');
      const ctx = c.getContext('2d', { alpha: true });
      let w = c.width = window.innerWidth;
      let h = c.height = window.innerHeight;

      const particles = [];
      const numParticles = 15; // Ainda mais minimal
      const chars = '01';

      for (let i = 0; i < numParticles; i++) {
        particles.push({
          x: Math.random() * w,
          y: h + Math.random() * 200,
          vy: 0.3 + Math.random() * 0.4,
          char: chars[Math.floor(Math.random() * chars.length)]
        });
      }

      const resize = () => { w = c.width = window.innerWidth; h = c.height = window.innerHeight; };

      const draw = () => {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.98)';
        ctx.fillRect(0, 0, w, h);

        ctx.fillStyle = 'rgba(6, 78, 59, 0.4)';
        ctx.font = '20px monospace';
        ctx.textBaseline = 'bottom';

        particles.forEach(p => {
          ctx.fillText(p.char, p.x, p.y);
          p.y -= p.vy;
          if (p.y < 0) {
            p.y = h + 100;
            p.x = Math.random() * w;
            p.char = chars[Math.random() < 0.5 ? 0 : 1];
          }
        });
      };

      const loop = () => { requestAnimationFrame(loop); draw(); };
      loop();
      window.addEventListener('resize', resize);
    })();
  </script>
</div>
